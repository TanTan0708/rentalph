<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boarding House Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c5f2d;
            --primary-dark: #1a3a1b;
            --accent: #d4a574;
            --bg-light: #fafaf8;
            --bg-white: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #e0e0dc;
            --success: #4a7c59;
            --warning: #d97706;
            --error: #c93c37;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #fafaf8 0%, #f0f0ed 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--primary);
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(44, 95, 45, 0.2);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(212, 165, 116, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            position: relative;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: var(--bg-white);
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
            height: fit-content;
        }

        .content-area {
            background: var(--bg-white);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
            min-height: 500px;
        }

        .section-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
            margin-bottom: 24px;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: #f5f5f2;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #e8f5e9;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.3);
        }

        .btn-secondary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background: #c89560;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            transform: none;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .summary-table th,
        .summary-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .summary-table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--primary-dark);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .summary-table tr:hover {
            background: var(--bg-light);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .status-deposit {
            background: #fff3cd;
            color: #856404;
        }

        .status-vacant {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-down {
            background: #f8d7da;
            color: #721c24;
        }

        .status-other {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .edit-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .edit-table th,
        .edit-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .edit-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .edit-table input,
        .edit-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Work Sans', sans-serif;
            margin-bottom: 0;
        }

        .edit-table input:focus,
        .edit-table select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .file-info {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .file-info strong {
            color: var(--text-primary);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        .location-count {
            background: var(--accent);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Boarding House Manager</h1>
            <p class="subtitle">Track payments and manage multiple locations</p>
        </header>

        <div class="main-grid">
            <div class="sidebar">
                <h2 class="section-title">Upload Data</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p><strong>Click or drag Excel file here</strong></p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                        One sheet per location
                    </p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>

                <div id="fileInfo" class="file-info" style="display: none;">
                    <strong>Loaded:</strong> <span id="fileName"></span><br>
                    <strong>Locations:</strong> <span id="locationCount"></span>
                </div>

                <h2 class="section-title" style="margin-top: 32px;">Select Location</h2>
                <select id="locationSelect" disabled>
                    <option value="">-- Upload file first --</option>
                </select>

                <button class="btn btn-primary btn-full" id="summaryBtn" disabled>
                    üìä View Payment Summary
                </button>

                <button class="btn btn-outline btn-full" id="editBtn" disabled style="margin-top: 12px;">
                    ‚úèÔ∏è Edit Records
                </button>

                <button class="btn btn-secondary btn-full" id="downloadBtn" disabled style="margin-top: 12px;">
                    üíæ Download Excel
                </button>
            </div>

            <div class="content-area">
                <div id="contentDisplay">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Data Loaded</h3>
                        <p>Upload an Excel file to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workbookData = null;
        let currentWorkbook = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const locationSelect = document.getElementById('locationSelect');
        const summaryBtn = document.getElementById('summaryBtn');
        const editBtn = document.getElementById('editBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const contentDisplay = document.getElementById('contentDisplay');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const locationCount = document.getElementById('locationCount');

        // Upload area interactions
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                currentWorkbook = XLSX.read(data, { type: 'array' });
                workbookData = {};

                // Parse all sheets
                currentWorkbook.SheetNames.forEach(sheetName => {
                    const sheet = currentWorkbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    workbookData[sheetName] = jsonData;
                });

                // Update UI
                fileName.textContent = file.name;
                locationCount.textContent = currentWorkbook.SheetNames.length;
                fileInfo.style.display = 'block';

                // Populate location select
                locationSelect.innerHTML = '<option value="">-- Select a location --</option>';
                currentWorkbook.SheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    locationSelect.appendChild(option);
                });

                locationSelect.disabled = false;
                summaryBtn.disabled = false;
                editBtn.disabled = false;
                downloadBtn.disabled = false;

                contentDisplay.innerHTML = `
                    <div class="empty-state fade-in">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3 style="color: var(--success);">File Loaded Successfully</h3>
                        <p>Select a location to view data</p>
                    </div>
                `;
            };
            reader.readAsArrayBuffer(file);
        }

        summaryBtn.addEventListener('click', showSummary);

        function formatAmountForDisplay(val) {
            if (val === undefined || val === null || val === '') return '';
            const s = String(val).replace(/,/g, '').trim();
            const n = Number(s);
            if (!isFinite(n)) return val;
            let fracDigits = 0;
            if (s.indexOf('.') >= 0) {
                fracDigits = Math.min(s.split('.')[1].length, 20);
            }
            return n.toLocaleString('en-US', { minimumFractionDigits: fracDigits, maximumFractionDigits: fracDigits });
        }

        function formatRemarkIfNumeric(val) {
            if (val === undefined || val === null || val === '') return val;
            const s = String(val).replace(/,/g, '').trim();
            const n = Number(s);
            if (!isFinite(n)) return val;
            let fracDigits = 0;
            if (s.indexOf('.') >= 0) {
                fracDigits = Math.min(s.split('.')[1].length, 20);
            }
            return n.toLocaleString('en-US', { minimumFractionDigits: fracDigits, maximumFractionDigits: fracDigits });
        }

        function showUnpaidAllLocations() {
            let allUnpaidHTML = `
                <div class="fade-in">
                    <h2 class="section-title">Unpaid Records - All Locations</h2>
                    <button class="btn btn-outline" onclick="showSummary()" style="margin-bottom: 16px;">‚Üê Back</button>
            `;

            let foundAny = false;
            const locations = Object.keys(workbookData).sort();

            locations.forEach(location => {
                const data = workbookData[location];
                if (!data || data.length < 2) return;

                const rows = data.slice(1);
                const unpaidRows = rows.filter(row => {
                    const hasData = row && row.some(cell => cell !== undefined && cell !== null && cell !== '');
                    if (!hasData) return false;
                    const remarks = row[4] || '';
                    return !remarks || remarks === '';
                });

                if (unpaidRows.length > 0) {
                    foundAny = true;
                    allUnpaidHTML += `
                        <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <h3 style="margin-top: 0; color: var(--text-primary);">${location} <span style="color: var(--text-secondary); font-weight: normal;">(${unpaidRows.length} unpaid)</span></h3>
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Room</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    unpaidRows.forEach(row => {
                        const month = row[0] || 'N/A';
                        const room = row[1] || 'N/A';
                        const date = row[2] !== undefined ? row[2] : 'N/A';
                        const amount = row[3] || '';
                        const amountDisplay = formatAmountForDisplay(amount);

                        allUnpaidHTML += `
                            <tr>
                                <td>${month}</td>
                                <td><strong>${room}</strong></td>
                                <td>${date}</td>
                                <td>${amountDisplay}</td>
                            </tr>
                        `;
                    });

                    allUnpaidHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });

            if (!foundAny) {
                allUnpaidHTML += `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <h3 style="color: var(--success);">All Rooms Paid!</h3>
                        <p>No unpaid records across all locations</p>
                    </div>
                `;
            }

            allUnpaidHTML += '</div>';
            contentDisplay.innerHTML = allUnpaidHTML;
        }

        function showSummary() {
            const location = locationSelect.value;
            if (!location) {
                alert('Please select a location first');
                return;
            }

            const data = workbookData[location];
            if (!data || data.length < 2) {
                contentDisplay.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>No Data Found</h3>
                        <p>This location has no records</p>
                    </div>
                `;
                return;
            }

            // Expected format: Month / Room / Date / Amount / Remarks
            const headers = data[0];
            const rows = data.slice(1);

            // Filter out completely empty rows only
            const allRows = rows.filter(row => {
                const hasData = row && row.some(cell => cell !== undefined && cell !== null && cell !== '');
                return hasData;
            });

            let summaryHTML = `
                <div class="fade-in">
                    <h2 class="section-title">Payment Summary - ${location} <span class="location-count">${allRows.length} records</span></h2>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="searchInput" placeholder="üîç Search by room, month, remarks..." style="flex: 1; min-width: 250px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <button class="btn btn-primary" onclick="filterByStatus('all')" id="filterAll">All</button>
                        <button class="btn btn-outline" onclick="filterByStatus('paid')" id="filterPaid">‚úì Paid</button>
                        <button class="btn btn-outline" onclick="filterByStatus('unpaid')" id="filterUnpaid">‚úó Unpaid</button>
                        <button class="btn btn-outline" onclick="showUnpaidAllLocations()" id="unpaidAllBtn">üîç Unpaid (All Locations)</button>
                    </div>
            `;

            if (allRows.length === 0) {
                summaryHTML += `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>No Data Found</h3>
                        <p>This location has no records</p>
                    </div>
                `;
            } else {
                summaryHTML += `
                    <table class="summary-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Room</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                allRows.forEach((row, idx) => {
                    const month = row[0] || 'N/A';      // 1st column - Month
                    const room = row[1] || 'N/A';       // 2nd column - Room
                    const date = row[2] !== undefined ? row[2] : 'N/A';       // 3rd column - Date
                    const amount = row[3] || '';        // 4th column - Amount
                    const amountDisplay = formatAmountForDisplay(amount);
                    const remarks = row[4] || '';       // 5th column - Remarks
                    
                    // Determine filter status: unpaid = blank amount, paid = has amount
                    let statusAttr = amount ? 'paid' : 'unpaid';
                    
                    // Determine status styling based on remarks
                    let statusClass = 'status-unpaid';
                    
                    if (remarks) {
                        const remarksLower = remarks.toString().toLowerCase();
                        if (remarksLower.includes('deposit')) {
                            statusClass = 'status-deposit';
                        } else if (remarksLower.includes('vacant')) {
                            statusClass = 'status-vacant';
                        } else if (remarksLower.includes('down')) {
                            statusClass = 'status-down';
                        } else if (remarks) {
                            statusClass = 'status-other';
                        }
                    }
                    
                    const searchText = `${month} ${room} ${date} ${amount} ${remarks}`.toLowerCase();
                    
                    // Determine remarks display
                    let remarksDisplay = '';
                    if (remarks) {
                        const formattedRemark = formatRemarkIfNumeric(remarks);
                        remarksDisplay = `<span class="status-badge ${statusClass}">${formattedRemark}</span>`;
                    } else if (amount) {
                        remarksDisplay = `<span class="status-badge status-paid">Paid</span>`;
                    }
                    
                    summaryHTML += `
                        <tr data-status="${statusAttr}" data-search="${searchText}" data-row-idx="${idx}">
                            <td>${month}</td>
                            <td><strong>${room}</strong></td>
                            <td>${date}</td>
                            <td>${amountDisplay}</td>
                                <td>${remarksDisplay}</td>
                        </tr>
                    `;
                });

                summaryHTML += `
                        </tbody>
                    </table>
                `;
            }

            summaryHTML += '</div>';
            contentDisplay.innerHTML = summaryHTML;
            
            // Setup filter and search functionality
            setupSummaryFilters();
        }
        
        function setupSummaryFilters() {
            const searchInput = document.getElementById('searchInput');
            const filterButtons = document.querySelectorAll('button[onclick*="filterByStatus"]');
            
            window.currentFilter = 'all';
            window.currentSearch = '';
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    window.currentSearch = e.target.value.toLowerCase();
                    applyFilters();
                });
            }
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('btn-primary'));
                    filterButtons.forEach(b => b.classList.add('btn-outline'));
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-primary');
                });
            });
        }
        
        function filterByStatus(status) {
            window.currentFilter = status;
            applyFilters();
        }
        
        function applyFilters() {
            const rows = document.querySelectorAll('#summaryTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                const rowSearch = row.getAttribute('data-search');
                
                let show = true;
                
                // Apply status filter
                if (window.currentFilter !== 'all' && rowStatus !== window.currentFilter) {
                    show = false;
                }
                
                // Apply search filter
                if (window.currentSearch && !rowSearch.includes(window.currentSearch)) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            // Update record count
            const locationCount = document.querySelector('.location-count');
            if (locationCount) {
                locationCount.textContent = `${visibleCount} records`;
            }
        }

        editBtn.addEventListener('click', showEditView);

        function showEditView() {
            const location = locationSelect.value;
            if (!location) {
                alert('Please select a location first');
                return;
            }

            const data = workbookData[location];
            if (!data || data.length < 2) {
                contentDisplay.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>No Data Found</h3>
                        <p>This location has no records</p>
                    </div>
                `;
                return;
            }

            const headers = data[0];
            const rows = data.slice(1);

            let editHTML = `
                <div class="fade-in">
                    <h2 class="section-title">Edit Records - ${location}</h2>
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">
                        <strong>Click any cell to edit.</strong> Common Remarks: Vacant, Down, Deposit, Additional Deposit of Room [#]
                    </p>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="editSearchInput" placeholder="üîç Search by room, month, remarks..." style="flex: 1; min-width: 250px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <button class="btn btn-primary" onclick="filterEditByStatus('all')" id="editFilterAll">All</button>
                        <button class="btn btn-outline" onclick="filterEditByStatus('paid')" id="editFilterPaid">‚úì Paid</button>
                        <button class="btn btn-outline" onclick="filterEditByStatus('unpaid')" id="editFilterUnpaid">‚úó Unpaid</button>
                    </div>
                    
                    <table class="summary-table" id="editTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Room</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            rows.forEach((row, idx) => {
                // Skip completely empty rows
                const hasData = row && row.some(cell => cell !== undefined && cell !== null && cell !== '');
                if (!hasData) return;
                
                const month = row[0] || '';
                const room = row[1] || '';
                const date = row[2] !== undefined ? row[2] : '';
                const amount = row[3] || '';
                const remarks = row[4] || '';
                
                // Determine filter status: unpaid = blank amount, paid = has amount
                let statusAttr = amount ? 'paid' : 'unpaid';
                const searchText = `${month} ${room} ${date} ${amount} ${remarks}`.toLowerCase();
                
                editHTML += `
                    <tr data-status="${statusAttr}" data-search="${searchText}">
                        <td><input type="text" value="${month}" data-row="${idx}" data-col="0" class="edit-input"></td>
                        <td><input type="text" value="${room}" data-row="${idx}" data-col="1" class="edit-input"></td>
                        <td><input type="text" value="${date}" data-row="${idx}" data-col="2" class="edit-input"></td>
                        <td><input type="text" value="${amount}" data-row="${idx}" data-col="3" class="edit-input"></td>
                        <td><input type="text" value="${remarks}" data-row="${idx}" data-col="4" class="edit-input"></td>
                    </tr>
                `;
            });

            editHTML += `
                        </tbody>
                    </table>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="saveEdits()">üíæ Save Changes</button>
                        <button class="btn btn-outline" onclick="showSummary()">‚ùå Cancel</button>
                    </div>
                </div>
            `;

            contentDisplay.innerHTML = editHTML;

            // Setup filters and search for edit view
            setupEditFilters();

            // Add change listeners to update workbookData
            const inputs = contentDisplay.querySelectorAll('.edit-input');
            inputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    const location = locationSelect.value;
                    
                    // Row + 1 because data[0] is headers, data[1] onwards are actual rows
                    if (!workbookData[location][row + 1]) {
                        workbookData[location][row + 1] = [];
                    }
                    workbookData[location][row + 1][col] = e.target.value;
                });
                
                // Also update on input so changes reflect in real-time
                input.addEventListener('input', (e) => {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    const location = locationSelect.value;
                    
                    if (!workbookData[location][row + 1]) {
                        workbookData[location][row + 1] = [];
                    }
                    workbookData[location][row + 1][col] = e.target.value;
                });
            });
        }
        
        function setupEditFilters() {
            const searchInput = document.getElementById('editSearchInput');
            const filterButtons = document.querySelectorAll('button[onclick*="filterEditByStatus"]');
            
            window.currentEditFilter = 'all';
            window.currentEditSearch = '';
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    window.currentEditSearch = e.target.value.toLowerCase();
                    applyEditFilters();
                });
            }
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('btn-primary'));
                    filterButtons.forEach(b => b.classList.add('btn-outline'));
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-primary');
                });
            });
        }
        
        function filterEditByStatus(status) {
            window.currentEditFilter = status;
            applyEditFilters();
        }
        
        function applyEditFilters() {
            const rows = document.querySelectorAll('#editTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                const rowSearch = row.getAttribute('data-search');
                
                let show = true;
                
                // Apply status filter
                if (window.currentEditFilter !== 'all' && rowStatus !== window.currentEditFilter) {
                    show = false;
                }
                
                // Apply search filter
                if (window.currentEditSearch && !rowSearch.includes(window.currentEditSearch)) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
        }

        function saveEdits() {
            const location = locationSelect.value;
            
            // Update the workbook with the edited data
            const ws = XLSX.utils.aoa_to_sheet(workbookData[location]);
            currentWorkbook.Sheets[location] = ws;

            alert('‚úÖ Changes saved successfully!');
            showSummary();
        }

        downloadBtn.addEventListener('click', downloadExcel);

        function downloadExcel() {
            if (!currentWorkbook) {
                alert('No file loaded');
                return;
            }

            // Create a new workbook with all the data
            const wb = XLSX.utils.book_new();
            
            Object.keys(workbookData).forEach(sheetName => {
                const ws = XLSX.utils.aoa_to_sheet(workbookData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            // Download the file
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `boarding-house-data-${timestamp}.xlsx`);
        }
    </script>
</body>
</html>